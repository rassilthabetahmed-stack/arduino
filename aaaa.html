<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Smart Wheelchair</title>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image"></script>

  <style>
    body { text-align: center; font-family: Arial; }
    video { width: 90%; border-radius: 10px; }
    button { font-size: 18px; margin: 10px; padding: 10px 20px; }
  </style>
</head>

<body>

<h2>ðŸš€ Smart Wheelchair Control</h2>

<button onclick="connectBluetooth()">ðŸ”µ Bluetooth</button>
<br>
<video id="webcam" autoplay></video>
<p id="result">---</p>

<script>
const URL = "model/";

let model, webcam, btChar;

// ===== Load Model =====
async function init() {
  model = await tmImage.load(URL + "model.json", URL + "metadata.json");

  webcam = new tmImage.Webcam(300, 300, true);
  await webcam.setup();
  await webcam.play();

  document.getElementById("webcam").srcObject = webcam.webcam;

  window.requestAnimationFrame(loop);
}

async function loop() {
  webcam.update();
  await predict();
  window.requestAnimationFrame(loop);
}

// ===== Prediction =====
async function predict() {
  const prediction = await model.predict(webcam.canvas);

  let best = prediction.reduce((a, b) => a.probability > b.probability ? a : b);

  document.getElementById("result").innerText =
    best.className + " : " + best.probability.toFixed(2);

  if (best.probability > 0.8 && btChar) {
    sendCommand(best.className);
  }
}

// ===== Bluetooth =====
async function connectBluetooth() {
  const device = await navigator.bluetooth.requestDevice({
    acceptAllDevices: true,
    optionalServices: ['00001101-0000-1000-8000-00805f9b34fb']
  });

  const server = await device.gatt.connect();
  const service = await server.getPrimaryService('00001101-0000-1000-8000-00805f9b34fb');
  btChar = await service.getCharacteristic('00001101-0000-1000-8000-00805f9b34fb');

  alert("Bluetooth Connected");
}

function sendCommand(cmd) {
  let value = 'B';

  if (cmd === "Forward") value = 'F';
  if (cmd === "Left") value = 'L';
  if (cmd === "Right") value = 'R';
  if (cmd === "Stop") value = 'B';

  btChar.writeValue(new TextEncoder().encode(value));
}

// Start
init();
</script>

</body>
</html>
