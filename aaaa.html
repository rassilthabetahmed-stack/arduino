<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Smart Wheelchair - Bluetooth HC05</title>
  
  <!-- TensorFlow.js & Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image"></script>

  <style>
    body { text-align: center; font-family: Arial; background: #f5f5f5; }
    video { width: 90%; max-width: 400px; border-radius: 10px; margin-top: 20px; }
    button { font-size: 18px; margin: 10px; padding: 10px 20px; border-radius: 5px; }
    #result { font-size: 20px; margin-top: 10px; font-weight: bold; }
  </style>
</head>

<body>
<h2>ğŸš€ Smart Wheelchair Control (HC-05)</h2>

<button onclick="connectBluetooth()">ğŸ”µ Connect HC-05</button>
<video id="webcam" autoplay></video>
<p id="result">---</p>

<script>
const MODEL_URL = "PUT_YOUR_MODEL_URL_HERE/"; // Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ù†Ù…ÙˆØ°Ø¬ Teachable Machine Ù‡Ù†Ø§
let model, webcam, btChar;

// ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ =====
async function init() {
  model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");

  webcam = new tmImage.Webcam(300, 300, true);
  await webcam.setup();
  await webcam.play();

  document.getElementById("webcam").srcObject = webcam.webcam;
  window.requestAnimationFrame(loop);
}

// ===== ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ¹Ù…Ù„ Ø§Ù„ØªÙ†Ø¨Ø¤ =====
async function loop() {
  webcam.update();
  await predict();
  window.requestAnimationFrame(loop);
}

// ===== Ø§Ù„ØªÙ†Ø¨Ø¤ Ø¨ÙˆØ§Ø³Ø·Ø© Teachable Machine =====
async function predict() {
  const prediction = await model.predict(webcam.canvas);

  // Ù†Ø£Ø®Ø° Ø£Ø¹Ù„Ù‰ Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ©
  let best = prediction.reduce((a, b) => a.probability > b.probability ? a : b);
  document.getElementById("result").innerText =
    best.className + " : " + (best.probability * 100).toFixed(0) + "%";

  // Ø¥Ø±Ø³Ø§Ù„ Ø£ÙˆØ§Ù…Ø± Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„
  if (btChar && best.probability > 0.8) {
    sendCommand(best.className);
  }
}

// ===== Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ« (ÙÙ„ØªØ± HC-05/06 ÙÙ‚Ø·) =====
async function connectBluetooth() {
  try {
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: "HC" }],  // ÙŠØ¸Ù‡Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØªÙŠ ØªØ¨Ø¯Ø£ Ø¨Ù€ "HC"
      optionalServices: ['00001101-0000-1000-8000-00805f9b34fb'] // Serial Port
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService('00001101-0000-1000-8000-00805f9b34fb');
    btChar = await service.getCharacteristic('00001101-0000-1000-8000-00805f9b34fb');

    alert("âœ… Connected to " + device.name);
  } catch (err) {
    alert("âŒ Connection failed: " + err);
  }
}

// ===== Ø¥Ø±Ø³Ø§Ù„ Ø£ÙˆØ§Ù…Ø± Ø¥Ù„Ù‰ Arduino =====
function sendCommand(cmd) {
  let value = 'B'; // Stop Ø§ÙØªØ±Ø§Ø¶ÙŠ

  if (cmd === "Forward") value = 'F';
  if (cmd === "Left") value = 'L';
  if (cmd === "Right") value = 'R';
  if (cmd === "Stop") value = 'B';

  btChar.writeValue(new TextEncoder().encode(value));
}

// ===== Ø¨Ø¯Ø¡ ÙƒÙ„ Ø´ÙŠØ¡ =====
init();
</script>

</body>
</html>
